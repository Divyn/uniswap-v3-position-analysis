<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Uniswap V3 Position Creators - Interactive Analysis</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .controls {
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            background-color: white;
        }
        #chart {
            width: 100%;
            height: 600px;
        }
        .loading {
            text-align: center;
            padding: 50px;
            color: #666;
        }
        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .stat-card {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #007bff;
            min-width: 150px;
        }
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }
        .stat-label {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }
        .creator-table {
            margin-top: 20px;
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f8f9fa;
            font-weight: bold;
        }
        .address {
            font-family: monospace;
            font-size: 12px;
            color: #666;
        }
        .number {
            text-align: right;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Uniswap V3 Position Creators - Interactive Analysis</h1>
        
        <div class="stats" id="stats">
            <div class="stat-card">
                <div class="stat-number" id="total-creators">-</div>
                <div class="stat-label">Total Creators</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="total-positions">-</div>
                <div class="stat-label">Total Positions</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="avg-positions">-</div>
                <div class="stat-label">Avg Positions/Creator</div>
            </div>
        </div>
        
        <div class="controls">
            <label for="chartType">Chart Type:</label>
            <select id="chartType">
                <option value="positions">Top Creators by Positions</option>
                <option value="liquidity">Top Creators by Liquidity</option>
                <option value="unique-pairs">Top Creators by Unique Pairs</option>
                <option value="distribution">Position Distribution</option>
            </select>
            
            <label for="topN">Show Top:</label>
            <select id="topN">
                <option value="10">Top 10</option>
                <option value="20">Top 20</option>
                <option value="50">Top 50</option>
                <option value="100">Top 100</option>
            </select>
        </div>

        <div id="chart" class="loading">Loading chart...</div>
        
        <div class="creator-table" id="creatorTable" style="display: none;">
            <h3>Detailed Creator Data</h3>
            <table id="creatorTableBody">
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>Creator Address</th>
                        <th>Positions</th>
                        <th>Total Liquidity</th>
                        <th>Unique Pairs</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <script>
        let creatorsData = {};

        // Load data from the creator analysis file
        async function loadData() {
            try {
                console.log('Loading data from bitquery_responses/creator_analysis.json');
                const response = await fetch('bitquery_responses/creator_analysis.json');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                creatorsData = data.creator_stats;
                console.log('Loaded', Object.keys(creatorsData).length, 'creators');
                
                updateStats(data.summary);
                updateChart();
                
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('chart').innerHTML = 
                    '<div style="text-align: center; padding: 50px; color: #e74c3c;">Error loading data. Please make sure the creator analysis has been run first.</div>';
            }
        }

        function updateStats(summary) {
            document.getElementById('total-creators').textContent = summary.total_creators.toLocaleString();
            document.getElementById('total-positions').textContent = summary.total_positions.toLocaleString();
            document.getElementById('avg-positions').textContent = (summary.total_positions / summary.total_creators).toFixed(1);
        }

        function getSortedCreators(sortBy, topN = 20) {
            const creators = Object.entries(creatorsData);
            
            let sorted;
            switch(sortBy) {
                case 'positions':
                    sorted = creators.sort((a, b) => b[1].total_positions - a[1].total_positions);
                    break;
                case 'liquidity':
                    sorted = creators.sort((a, b) => b[1].total_liquidity - a[1].total_liquidity);
                    break;
                case 'unique-pairs':
                    sorted = creators.sort((a, b) => b[1].unique_pairs_count - a[1].unique_pairs_count);
                    break;
                default:
                    sorted = creators.sort((a, b) => b[1].total_positions - a[1].total_positions);
            }
            
            return sorted.slice(0, topN);
        }

        function updateChart() {
            const chartType = document.getElementById('chartType').value;
            const topN = parseInt(document.getElementById('topN').value);
            
            let sortedCreators = getSortedCreators(chartType, topN);
            
            switch(chartType) {
                case 'positions':
                    createBarChart(sortedCreators, 'Number of Positions', 'total_positions', '#3498db');
                    break;
                case 'liquidity':
                    createBarChart(sortedCreators, 'Total Liquidity', 'total_liquidity', '#e74c3c');
                    break;
                case 'unique-pairs':
                    createBarChart(sortedCreators, 'Unique Pairs', 'unique_pairs_count', '#f39c12');
                    break;
                case 'distribution':
                    createDistributionChart('total_positions', 'Position Distribution');
                    break;
            }
            
            updateCreatorTable(sortedCreators);
        }

        function createBarChart(creators, yLabel, dataKey, color) {
            const addresses = creators.map(([address, data]) => 
                address.substring(0, 6) + '...' + address.substring(address.length - 4)
            );
            const values = creators.map(([address, data]) => {
                return data[dataKey];
            });
            
            const trace = {
                x: addresses,
                y: values,
                type: 'bar',
                marker: { color: color },
                text: values.map(v => v.toLocaleString()),
                textposition: 'auto',
                hovertemplate: '<b>%{x}</b><br>' + yLabel + ': %{y:,.0f}<extra></extra>'
            };
            
            const layout = {
                title: `Top ${creators.length} Creators by ${yLabel}`,
                xaxis: { title: 'Creator Address' },
                yaxis: { title: yLabel },
                margin: { t: 50, r: 50, b: 100, l: 80 },
                showlegend: false
            };
            
            Plotly.newPlot('chart', [trace], layout, {responsive: true});
        }

        function createDistributionChart(dataKey, title) {
            const creators = Object.values(creatorsData);
            const values = creators.map(data => {
                return data[dataKey];
            }).filter(v => v > 0);
            
            const trace = {
                x: values,
                type: 'histogram',
                nbinsx: 20,
                marker: { color: '#9b59b6' },
                hovertemplate: 'Range: %{x}<br>Count: %{y}<extra></extra>'
            };
            
            const layout = {
                title: title,
                xaxis: { title: dataKey.replace('_', ' ').toUpperCase() },
                yaxis: { title: 'Number of Creators' },
                margin: { t: 50, r: 50, b: 80, l: 80 },
                showlegend: false
            };
            
            Plotly.newPlot('chart', [trace], layout, {responsive: true});
        }

        function updateCreatorTable(creators) {
            const tableBody = document.getElementById('creatorTableBody').getElementsByTagName('tbody')[0];
            tableBody.innerHTML = '';
            
            creators.forEach(([address, data], index) => {
                const row = tableBody.insertRow();
                
                row.insertCell(0).textContent = index + 1;
                row.insertCell(0).className = 'number';
                
                const addressCell = row.insertCell(1);
                addressCell.innerHTML = `<span class="address">${address}</span>`;
                
                const positionsCell = row.insertCell(2);
                positionsCell.textContent = data.total_positions.toLocaleString();
                positionsCell.className = 'number';
                
                const liquidityCell = row.insertCell(3);
                liquidityCell.textContent = data.total_liquidity.toLocaleString();
                liquidityCell.className = 'number';
                
                const pairsCell = row.insertCell(4);
                pairsCell.textContent = data.unique_pairs_count;
                pairsCell.className = 'number';
            });
            
            document.getElementById('creatorTable').style.display = 'table';
        }

        // Event listeners
        document.getElementById('chartType').addEventListener('change', updateChart);
        document.getElementById('topN').addEventListener('change', updateChart);

        // Load data when page loads
        loadData();
    </script>
</body>
</html>
