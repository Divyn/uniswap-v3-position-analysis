<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Uniswap V3 Positions - Interactive Chart</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .controls {
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            background-color: white;
        }
        #chart {
            width: 100%;
            height: 600px;
        }
        .loading {
            text-align: center;
            padding: 50px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Uniswap V3 Positions - Interactive Analysis</h1>
        
        <div class="controls">
            <label for="tokenSelect">Select Token:</label>
            <select id="tokenSelect">
                <option value="all">All Tokens</option>
            </select>
            
            <label for="pairSelect">Select Pair:</label>
            <select id="pairSelect">
                <option value="all">All Pairs</option>
            </select>
            
            <label for="chartType">Chart Type:</label>
            <select id="chartType">
                <option value="scatter">Scatter Plot (Liquidity vs Price Band)</option>
                <option value="bar">Bar Chart (Liquidity by Token)</option>
                <option value="pie">Pie Chart (Liquidity Distribution)</option>
                <option value="pair-bar">Bar Chart (Liquidity by Pair)</option>
            </select>
        </div>


        <div id="chart" class="loading">Loading chart...</div>
    </div>

    <script>
        let positionsData = [];
        let tokenDecimals = {};

        // Load data from the processed positions file
        async function loadData() {
            try {
                console.log('Loading data from bitquery_responses/processed_positions.json');
                const response = await fetch('bitquery_responses/processed_positions.json');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                positionsData = await response.json();
                console.log('Loaded', positionsData.length, 'positions');
                
                // Create token decimals lookup
                positionsData.forEach(pos => {
                    tokenDecimals[pos.token0.address] = {
                        symbol: pos.token0.symbol,
                        decimals: pos.token0.decimals
                    };
                    tokenDecimals[pos.token1.address] = {
                        symbol: pos.token1.symbol,
                        decimals: pos.token1.decimals
                    };
                });

                console.log('Populating dropdowns...');
                populateDropdowns();
                console.log('Updating chart...');
                updateChart();
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('chart').innerHTML = '<div class="loading">Error loading data. Please make sure the JSON file is accessible.</div>';
            }
        }

        function populateDropdowns() {
            const tokenSelect = document.getElementById('tokenSelect');
            const pairSelect = document.getElementById('pairSelect');
            const uniqueTokens = new Set();
            const uniquePairs = new Set();
            
            positionsData.forEach(pos => {
                uniqueTokens.add(pos.token0.symbol);
                uniqueTokens.add(pos.token1.symbol);
                
                // Create both possible pair orders
                const pair1 = `${pos.token0.symbol}/${pos.token1.symbol}`;
                const pair2 = `${pos.token1.symbol}/${pos.token0.symbol}`;
                uniquePairs.add(pair1);
                uniquePairs.add(pair2);
            });

            // Clear and populate token dropdown
            tokenSelect.innerHTML = '<option value="all">All Tokens</option>';
            Array.from(uniqueTokens).sort().forEach(token => {
                const option = document.createElement('option');
                option.value = token;
                option.textContent = token;
                tokenSelect.appendChild(option);
            });

            // Clear and populate pair dropdown
            pairSelect.innerHTML = '<option value="all">All Pairs</option>';
            Array.from(uniquePairs).sort().forEach(pair => {
                const option = document.createElement('option');
                option.value = pair;
                option.textContent = pair;
                pairSelect.appendChild(option);
            });
        }

        function getFilteredData() {
            const selectedToken = document.getElementById('tokenSelect').value;
            const selectedPair = document.getElementById('pairSelect').value;
            
            let filteredData = positionsData;
            
            // Filter by token
            if (selectedToken !== 'all') {
                filteredData = filteredData.filter(pos => 
                    pos.token0.symbol === selectedToken || pos.token1.symbol === selectedToken
                );
            }
            
            // Filter by pair
            if (selectedPair !== 'all') {
                filteredData = filteredData.filter(pos => {
                    const pair1 = `${pos.token0.symbol}/${pos.token1.symbol}`;
                    const pair2 = `${pos.token1.symbol}/${pos.token0.symbol}`;
                    return pair1 === selectedPair || pair2 === selectedPair;
                });
            }
            
            return filteredData;
        }

        function updateChart() {
            try {
                const filteredData = getFilteredData();
                const chartType = document.getElementById('chartType').value;

                console.log('Updating chart with', filteredData.length, 'positions');
                console.log('Chart type:', chartType);

                if (chartType === 'scatter') {
                    createScatterPlot(filteredData);
                } else if (chartType === 'bar') {
                    createBarChart(filteredData);
                } else if (chartType === 'pie') {
                    createPieChart(filteredData);
                } else if (chartType === 'pair-bar') {
                    createPairBarChart(filteredData);
                }
            } catch (error) {
                console.error('Error updating chart:', error);
                document.getElementById('chart').innerHTML = '<div class="loading">Error creating chart. Check console for details.</div>';
            }
        }

        function createScatterPlot(data) {
            const traces = [];
            const tokenPairs = new Set();
            
            data.forEach(pos => {
                const pair = `${pos.token0.symbol}/${pos.token1.symbol}`;
                tokenPairs.add(pair);
            });

            let colorIndex = 0;
            const colors = ['#1f77b4', '#ff7f0e', '#2ca02c', '#d62728', '#9467bd', '#8c564b', '#e377c2', '#7f7f7f', '#bcbd22', '#17becf'];

            tokenPairs.forEach(pair => {
                const pairData = data.filter(pos => `${pos.token0.symbol}/${pos.token1.symbol}` === pair);
                
                const trace = {
                    x: pairData.map(pos => pos.price_band.lower),
                    y: pairData.map(pos => parseFloat(pos.liquidity)),
                    mode: 'markers',
                    type: 'scatter',
                    name: pair,
                    text: pairData.map(pos => 
                        `Token ID: ${pos.tokenId}<br>` +
                        `Pair: ${pos.token0.symbol}/${pos.token1.symbol}<br>` +
                        `Liquidity: ${pos.liquidity}<br>` +
                        `Price Band: ${pos.price_band.lower.toFixed(6)} - ${pos.price_band.upper.toFixed(6)}<br>` +
                        `Fee: ${pos.fee} (${(pos.fee/10000).toFixed(2)}%)`
                    ),
                    hovertemplate: '%{text}<extra></extra>',
                    marker: {
                        size: 8,
                        color: colors[colorIndex % colors.length],
                        opacity: 0.7
                    }
                };
                
                traces.push(trace);
                colorIndex++;
            });

            const layout = {
                title: 'Liquidity Positions: Price Band vs Liquidity Amount',
                xaxis: {
                    title: 'Lower Price Band',
                    type: 'log'
                },
                yaxis: {
                    title: 'Liquidity Amount',
                    type: 'log'
                },
                hovermode: 'closest',
                showlegend: true,
                legend: {
                    orientation: 'v',
                    x: 1.02,
                    y: 1
                }
            };

            Plotly.newPlot('chart', traces, layout, {responsive: true});
        }

        function createBarChart(data) {
            const tokenLiquidity = {};
            
            data.forEach(pos => {
                const token0 = pos.token0.symbol;
                const token1 = pos.token1.symbol;
                
                if (!tokenLiquidity[token0]) tokenLiquidity[token0] = 0;
                if (!tokenLiquidity[token1]) tokenLiquidity[token1] = 0;
                
                tokenLiquidity[token0] += parseFloat(pos.liquidity);
                tokenLiquidity[token1] += parseFloat(pos.liquidity);
            });

            const tokens = Object.keys(tokenLiquidity).sort();
            const liquidity = tokens.map(token => tokenLiquidity[token]);

            const trace = {
                x: tokens,
                y: liquidity,
                type: 'bar',
                marker: {
                    color: '#007bff',
                    opacity: 0.7
                },
                text: liquidity.map(val => val.toFixed(2)),
                textposition: 'auto'
            };

            const layout = {
                title: 'Total Liquidity by Token',
                xaxis: { title: 'Token' },
                yaxis: { title: 'Total Liquidity' },
                hovermode: 'closest'
            };

            Plotly.newPlot('chart', [trace], layout, {responsive: true});
        }

        function createPieChart(data) {
            const tokenLiquidity = {};
            
            data.forEach(pos => {
                const token0 = pos.token0.symbol;
                const token1 = pos.token1.symbol;
                
                if (!tokenLiquidity[token0]) tokenLiquidity[token0] = 0;
                if (!tokenLiquidity[token1]) tokenLiquidity[token1] = 0;
                
                tokenLiquidity[token0] += parseFloat(pos.liquidity);
                tokenLiquidity[token1] += parseFloat(pos.liquidity);
            });

            const tokens = Object.keys(tokenLiquidity);
            const liquidity = Object.values(tokenLiquidity);

            const trace = {
                labels: tokens,
                values: liquidity,
                type: 'pie',
                textinfo: 'label+percent',
                textposition: 'outside',
                hovertemplate: '<b>%{label}</b><br>Liquidity: %{value:.2f}<br>Percentage: %{percent}<extra></extra>'
            };

            const layout = {
                title: 'Liquidity Distribution by Token',
                showlegend: true,
                legend: {
                    orientation: 'v',
                    x: 1.02,
                    y: 1
                }
            };

            Plotly.newPlot('chart', [trace], layout, {responsive: true});
        }

        function createPairBarChart(data) {
            const pairLiquidity = {};
            
            data.forEach(pos => {
                const pair = `${pos.token0.symbol}/${pos.token1.symbol}`;
                
                if (!pairLiquidity[pair]) {
                    pairLiquidity[pair] = 0;
                }
                
                pairLiquidity[pair] += parseFloat(pos.liquidity);
            });

            const pairs = Object.keys(pairLiquidity).sort();
            const liquidity = pairs.map(pair => pairLiquidity[pair]);

            const trace = {
                x: pairs,
                y: liquidity,
                type: 'bar',
                marker: {
                    color: '#28a745',
                    opacity: 0.7
                },
                text: liquidity.map(val => val.toFixed(2)),
                textposition: 'auto'
            };

            const layout = {
                title: 'Total Liquidity by Trading Pair',
                xaxis: { 
                    title: 'Trading Pair',
                    tickangle: -45
                },
                yaxis: { title: 'Total Liquidity' },
                hovermode: 'closest'
            };

            Plotly.newPlot('chart', [trace], layout, {responsive: true});
        }

        // Event listeners
        document.getElementById('tokenSelect').addEventListener('change', updateChart);
        document.getElementById('pairSelect').addEventListener('change', updateChart);
        document.getElementById('chartType').addEventListener('change', updateChart);

        // Load data when page loads
        loadData();
    </script>
</body>
</html>
