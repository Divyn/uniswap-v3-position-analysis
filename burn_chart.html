<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Uniswap V3 Burn Events - Interactive Chart</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .controls {
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            background-color: white;
        }
        #chart {
            width: 100%;
            height: 600px;
        }
        .loading {
            text-align: center;
            padding: 50px;
            color: #666;
        }
        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .stat-card {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #dc3545;
            min-width: 150px;
        }
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }
        .stat-label {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }
        .info-box {
            background-color: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .info-box h3 {
            margin-top: 0;
            color: #856404;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background-color: white;
        }
        th {
            background-color: #dc3545;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: bold;
        }
        td {
            padding: 10px 12px;
            border-bottom: 1px solid #ddd;
        }
        tr:hover {
            background-color: #f5f5f5;
        }
        .table-container {
            max-height: 500px;
            overflow-y: auto;
            margin-bottom: 20px;
        }
        .address-cell {
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üî• Uniswap V3 Burn Events - Position Closure Analysis</h1>
        
        <div class="info-box">
            <h3>‚ÑπÔ∏è About Burn Events</h3>
            <p><strong>Note:</strong> Burn events destroy NFT positions by their tokenId. Unlike mint events, burn events do not contain token pair information (token0/token1) since they only reference the NFT position ID. This analysis focuses on burn patterns, timing, and burner behavior.</p>
        </div>

        <div class="stats" id="stats">
            <div class="stat-card">
                <div class="stat-number" id="total-burns">-</div>
                <div class="stat-label">Total Burn Events</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="unique-burners">-</div>
                <div class="stat-label">Unique Burners</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="avg-burns">-</div>
                <div class="stat-label">Avg Burns per Burner</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="peak-day">-</div>
                <div class="stat-label">Peak Day Burns</div>
            </div>
        </div>
        
        <div class="controls">
            <label for="chartType">View Type:</label>
            <select id="chartType">
                <option value="token-table">Token ID Burn Count (Table)</option>
                <option value="burner-table">Burner Count (Table)</option>
                <option value="daily">Daily Burn Count (Chart)</option>
                <option value="hourly">Hourly Distribution (Chart)</option>
                <option value="top-burners">Top 20 Burners (Chart)</option>
            </select>
        </div>

        <div id="chart" class="loading">Loading chart...</div>
    </div>

    <script>
        let burnData = [];
        let analysisData = {};

        // Load data from the processed burn events file
        async function loadData() {
            try {
                console.log('Loading burn data from bitquery_responses/processed_burn_events.json');
                const response = await fetch('bitquery_responses/processed_burn_events.json');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                burnData = await response.json();
                console.log('Loaded', burnData.length, 'burn events');
                
                // Load analysis data if available
                try {
                    const analysisResponse = await fetch('bitquery_responses/burn_analysis.json');
                    if (analysisResponse.ok) {
                        analysisData = await analysisResponse.json();
                        updateStats();
                    }
                } catch (e) {
                    console.log('No analysis data available');
                }
                
                // Initial chart
                updateChart();
                
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('chart').innerHTML = 
                    '<div class="loading">Error loading data. Please make sure to run the burn processing script first: <code>python process_burn.py</code></div>';
            }
        }

        function updateStats() {
            if (analysisData.total_burns !== undefined) {
                document.getElementById('total-burns').textContent = analysisData.total_burns.toLocaleString();
                document.getElementById('unique-burners').textContent = analysisData.unique_burners.toLocaleString();
                document.getElementById('avg-burns').textContent = analysisData.avg_burns_per_burner.toFixed(2);
                
                if (analysisData.peak_day && analysisData.peak_day.count) {
                    document.getElementById('peak-day').textContent = analysisData.peak_day.count.toLocaleString();
                }
            } else {
                // Calculate from burnData if analysis not available
                const uniqueBurners = new Set(burnData.map(e => e.transaction.from)).size;
                document.getElementById('total-burns').textContent = burnData.length.toLocaleString();
                document.getElementById('unique-burners').textContent = uniqueBurners.toLocaleString();
                document.getElementById('avg-burns').textContent = (burnData.length / uniqueBurners).toFixed(2);
            }
        }

        function updateChart() {
            const chartType = document.getElementById('chartType').value;
            
            if (burnData.length === 0) {
                document.getElementById('chart').innerHTML = '<div class="loading">No burn event data available.</div>';
                return;
            }
            
            // Check if it's a table view or chart view
            if (chartType === 'token-table') {
                createTokenIdTable();
                return;
            } else if (chartType === 'burner-table') {
                createBurnerTable();
                return;
            }
            
            // Otherwise, create a chart
            let traces, layout;
            
            switch (chartType) {
                case 'daily':
                    ({traces, layout} = createDailyChart());
                    break;
                case 'hourly':
                    ({traces, layout} = createHourlyChart());
                    break;
                case 'top-burners':
                    ({traces, layout} = createTopBurnersChart());
                    break;
                default:
                    ({traces, layout} = createDailyChart());
            }
            
            Plotly.newPlot('chart', traces, layout, {responsive: true});
        }

        function createTokenIdTable() {
            // Count burns per token ID
            const tokenIdCounts = {};
            const tokenIdDetails = {};
            
            burnData.forEach(event => {
                const tokenId = event.tokenId;
                tokenIdCounts[tokenId] = (tokenIdCounts[tokenId] || 0) + 1;
                
                if (!tokenIdDetails[tokenId]) {
                    tokenIdDetails[tokenId] = [];
                }
                tokenIdDetails[tokenId].push({
                    burner: event.transaction.from,
                    time: event.block.time,
                    hash: event.transaction.hash
                });
            });
            
            // Sort by burn count (descending)
            const sortedTokenIds = Object.entries(tokenIdCounts)
                .sort((a, b) => b[1] - a[1]);
            
            // Create table HTML
            let tableHTML = `
                <h3>Token ID Burn Count (${sortedTokenIds.length} unique positions)</h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Token ID (NFT Position)</th>
                                <th>Burn Count</th>
                                <th>First Burn Time</th>
                                <th>Last Burn Time</th>
                                <th>Details</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            sortedTokenIds.forEach(([tokenId, count], index) => {
                const details = tokenIdDetails[tokenId];
                const times = details.map(d => new Date(d.time)).sort((a, b) => a - b);
                const firstBurn = times[0].toLocaleString();
                const lastBurn = times[times.length - 1].toLocaleString();
                
                tableHTML += `
                    <tr>
                        <td>${index + 1}</td>
                        <td style="font-weight: bold;">${tokenId}</td>
                        <td><strong style="color: #dc3545;">${count}</strong></td>
                        <td>${firstBurn}</td>
                        <td>${lastBurn}</td>
                        <td><button onclick='showTokenDetails("${tokenId}")' style="padding: 5px 10px; cursor: pointer;">View</button></td>
                    </tr>
                `;
            });
            
            tableHTML += `
                        </tbody>
                    </table>
                </div>
            `;
            
            document.getElementById('chart').innerHTML = tableHTML;
            
            // Store details for modal
            window.tokenIdDetails = tokenIdDetails;
        }

        function createBurnerTable() {
            // Count burns per burner
            const burnerCounts = {};
            const burnerDetails = {};
            
            burnData.forEach(event => {
                const burner = event.transaction.from;
                burnerCounts[burner] = (burnerCounts[burner] || 0) + 1;
                
                if (!burnerDetails[burner]) {
                    burnerDetails[burner] = [];
                }
                burnerDetails[burner].push({
                    tokenId: event.tokenId,
                    time: event.block.time,
                    hash: event.transaction.hash
                });
            });
            
            // Sort by burn count (descending)
            const sortedBurners = Object.entries(burnerCounts)
                .sort((a, b) => b[1] - a[1]);
            
            // Create table HTML
            let tableHTML = `
                <h3>Burner Address Burn Count (${sortedBurners.length} unique burners)</h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Burner Address</th>
                                <th>Burn Count</th>
                                <th>First Burn Time</th>
                                <th>Last Burn Time</th>
                                <th>Details</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            sortedBurners.forEach(([burner, count], index) => {
                const details = burnerDetails[burner];
                const times = details.map(d => new Date(d.time)).sort((a, b) => a - b);
                const firstBurn = times[0].toLocaleString();
                const lastBurn = times[times.length - 1].toLocaleString();
                
                tableHTML += `
                    <tr>
                        <td>${index + 1}</td>
                        <td class="address-cell">${burner}</td>
                        <td><strong style="color: #dc3545;">${count}</strong></td>
                        <td>${firstBurn}</td>
                        <td>${lastBurn}</td>
                        <td><button onclick='showBurnerDetails("${burner}")' style="padding: 5px 10px; cursor: pointer;">View</button></td>
                    </tr>
                `;
            });
            
            tableHTML += `
                        </tbody>
                    </table>
                </div>
            `;
            
            document.getElementById('chart').innerHTML = tableHTML;
            
            // Store details for modal
            window.burnerDetails = burnerDetails;
        }

        function showTokenDetails(tokenId) {
            const details = window.tokenIdDetails[tokenId];
            
            let detailsHTML = `
                <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                           background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                           max-width: 80%; max-height: 80%; overflow-y: auto; z-index: 1000;">
                    <h3>Token ID ${tokenId} - Burn Details</h3>
                    <p><strong>Total Burns:</strong> ${details.length}</p>
                    <table style="width: 100%; margin-top: 20px;">
                        <thead>
                            <tr>
                                <th>Burner Address</th>
                                <th>Time</th>
                                <th>Transaction Hash</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            details.forEach(d => {
                detailsHTML += `
                    <tr>
                        <td class="address-cell">${d.burner}</td>
                        <td>${new Date(d.time).toLocaleString()}</td>
                        <td class="address-cell"><a href="https://etherscan.io/tx/${d.hash}" target="_blank">${d.hash.substring(0, 10)}...</a></td>
                    </tr>
                `;
            });
            
            detailsHTML += `
                        </tbody>
                    </table>
                    <button onclick="this.parentElement.parentElement.remove()" 
                            style="margin-top: 20px; padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        Close
                    </button>
                </div>
            `;
            
            const overlay = document.createElement('div');
            overlay.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999;';
            overlay.innerHTML = detailsHTML;
            overlay.onclick = function(e) {
                if (e.target === overlay) overlay.remove();
            };
            
            document.body.appendChild(overlay);
        }

        function showBurnerDetails(burner) {
            const details = window.burnerDetails[burner];
            
            let detailsHTML = `
                <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                           background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                           max-width: 80%; max-height: 80%; overflow-y: auto; z-index: 1000;">
                    <h3>Burner Details</h3>
                    <p class="address-cell"><strong>Address:</strong> ${burner}</p>
                    <p><strong>Total Burns:</strong> ${details.length}</p>
                    <table style="width: 100%; margin-top: 20px;">
                        <thead>
                            <tr>
                                <th>Token ID</th>
                                <th>Time</th>
                                <th>Transaction Hash</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            details.forEach(d => {
                detailsHTML += `
                    <tr>
                        <td><strong>${d.tokenId}</strong></td>
                        <td>${new Date(d.time).toLocaleString()}</td>
                        <td class="address-cell"><a href="https://etherscan.io/tx/${d.hash}" target="_blank">${d.hash.substring(0, 10)}...</a></td>
                    </tr>
                `;
            });
            
            detailsHTML += `
                        </tbody>
                    </table>
                    <button onclick="this.parentElement.parentElement.remove()" 
                            style="margin-top: 20px; padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        Close
                    </button>
                </div>
            `;
            
            const overlay = document.createElement('div');
            overlay.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999;';
            overlay.innerHTML = detailsHTML;
            overlay.onclick = function(e) {
                if (e.target === overlay) overlay.remove();
            };
            
            document.body.appendChild(overlay);
        }

        function createDailyChart() {
            // Group by day
            const dailyCounts = {};
            
            burnData.forEach(event => {
                const date = new Date(event.block.time).toISOString().split('T')[0];
                dailyCounts[date] = (dailyCounts[date] || 0) + 1;
            });
            
            const sortedDates = Object.keys(dailyCounts).sort();
            const counts = sortedDates.map(date => dailyCounts[date]);
            
            const trace = {
                x: sortedDates,
                y: counts,
                type: 'bar',
                marker: {
                    color: '#dc3545',
                    opacity: 0.8
                },
                text: counts,
                textposition: 'auto',
                hovertemplate: '<b>Date:</b> %{x}<br><b>Burns:</b> %{y}<extra></extra>'
            };
            
            const layout = {
                title: 'Daily Burn Event Count',
                xaxis: { 
                    title: 'Date',
                    tickangle: -45
                },
                yaxis: { 
                    title: 'Number of Burn Events'
                },
                hovermode: 'closest'
            };
            
            return { traces: [trace], layout };
        }

        function createHourlyChart() {
            // Group by hour of day (0-23)
            const hourlyCounts = Array(24).fill(0);
            
            burnData.forEach(event => {
                const hour = new Date(event.block.time).getHours();
                hourlyCounts[hour]++;
            });
            
            const hours = Array.from({length: 24}, (_, i) => `${i}:00`);
            
            const trace = {
                x: hours,
                y: hourlyCounts,
                type: 'bar',
                marker: {
                    color: '#dc3545',
                    opacity: 0.8
                },
                text: hourlyCounts,
                textposition: 'auto',
                hovertemplate: '<b>Hour:</b> %{x}<br><b>Burns:</b> %{y}<extra></extra>'
            };
            
            const layout = {
                title: 'Burn Events by Hour of Day (UTC)',
                xaxis: { 
                    title: 'Hour of Day (UTC)',
                    tickangle: -45
                },
                yaxis: { 
                    title: 'Number of Burn Events'
                },
                hovermode: 'closest'
            };
            
            return { traces: [trace], layout };
        }

        function createTopBurnersChart() {
            // Count burns per address
            const burnerCounts = {};
            
            burnData.forEach(event => {
                const burner = event.transaction.from;
                burnerCounts[burner] = (burnerCounts[burner] || 0) + 1;
            });
            
            // Sort and get top 20
            const sortedBurners = Object.entries(burnerCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 20);
            
            const addresses = sortedBurners.map(([addr, _]) => 
                addr.substring(0, 8) + '...' + addr.substring(addr.length - 6)
            );
            const counts = sortedBurners.map(([_, count]) => count);
            const fullAddresses = sortedBurners.map(([addr, _]) => addr);
            
            const trace = {
                x: addresses,
                y: counts,
                type: 'bar',
                marker: {
                    color: '#dc3545',
                    opacity: 0.8
                },
                text: counts,
                textposition: 'auto',
                hovertemplate: '<b>Address:</b> %{customdata}<br><b>Burns:</b> %{y}<extra></extra>',
                customdata: fullAddresses
            };
            
            const layout = {
                title: 'Top 20 Position Burners',
                xaxis: { 
                    title: 'Burner Address',
                    tickangle: -45
                },
                yaxis: { 
                    title: 'Number of Burns'
                },
                hovermode: 'closest'
            };
            
            return { traces: [trace], layout };
        }

        // Event listeners
        document.getElementById('chartType').addEventListener('change', updateChart);

        // Load data when page loads
        loadData();
    </script>
</body>
</html>

